name: ğŸ”„ Auto Update Multiple Files

on:
  push:
    branches: [ main ]
  schedule:
    - cron: "0 1 * * *"  # ğŸ• æ¯å¤©å‡Œæ™¨1ç‚¹è‡ªåŠ¨è¿è¡Œ
  workflow_dispatch:      # ğŸ–ï¸ æ”¯æŒæ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

env:
  # é…ç½®è¦ä¸‹è½½çš„æ–‡ä»¶åˆ—è¡¨
  FILES_TO_DOWNLOAD: |
    [
      {
        "name": "worker_source",
        "url": "https://raw.githubusercontent.com/cmliu/edgetunnel/refs/heads/beta2.0/_worker.js",
        "save_as": "source.js",
        "process": true
      },
      {
        "name": "shadowsocks",
        "url": "https://raw.githubusercontent.com/eooce/Cloudflare-proxy/refs/heads/main/shadowsocks.js",
        "save_as": "shadowsocks.js",
        "process": false
      },
      {
        "name": "snippets",
        "url": "https://raw.githubusercontent.com/eooce/Cloudflare-proxy/refs/heads/main/snippets.js",
        "save_as": "snippets.js",
        "process": false
      }
    ]

jobs:
  update:
    name: ğŸš€ åŒæ­¥å¤šæºæ–‡ä»¶
    runs-on: ubuntu-latest
    steps:
      # ç¬¬ä¸€é˜¶æ®µï¼šåˆå§‹åŒ–é…ç½®
      - name: ğŸ“¥ åˆå§‹åŒ–ä»£ç ä»“åº“
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ğŸ› ï¸ é…ç½® Git ç¯å¢ƒ
        run: |
          echo "ğŸ¯ é…ç½® Git ç”¨æˆ·ä¿¡æ¯..."
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global pull.rebase false

      - name: ğŸ“¦ å®‰è£…æ„å»ºå·¥å…·
        run: |
          echo "ğŸ”§ å®‰è£…ä»£ç å‹ç¼©å’Œæ··æ·†å·¥å…·..."
          npm install -g terser javascript-obfuscator
          echo "âœ… å·¥å…·å®‰è£…å®Œæˆ"

      # ç¬¬äºŒé˜¶æ®µï¼šæ–‡ä»¶ä¸‹è½½å’Œæ£€æŸ¥
      - name: ğŸŒ æ‰¹é‡ä¸‹è½½è¿œç¨‹æ–‡ä»¶
        id: download_files
        run: |
          echo "ğŸ“¥ å¼€å§‹æ‰¹é‡ä¸‹è½½æ–‡ä»¶..."
          echo "$FILES_TO_DOWNLOAD" > files_config.json
          
          # åˆ›å»ºä¸‹è½½çŠ¶æ€æ–‡ä»¶
          DOWNLOAD_STATUS="{}"
          UPDATE_NEEDED="false"
          
          # è¯»å–æ–‡ä»¶é…ç½®
          FILES_COUNT=$(jq length files_config.json)
          echo "ğŸ“‹ éœ€è¦ä¸‹è½½çš„æ–‡ä»¶æ•°é‡: $FILES_COUNT"
          
          for i in $(seq 0 $(($FILES_COUNT - 1))); do
            FILE_NAME=$(jq -r ".[$i].name" files_config.json)
            FILE_URL=$(jq -r ".[$i].url" files_config.json)
            SAVE_AS=$(jq -r ".[$i].save_as" files_config.json)
            NEED_PROCESS=$(jq -r ".[$i].process" files_config.json)
            
            echo "---"
            echo "ğŸ”„ å¤„ç†æ–‡ä»¶: $FILE_NAME"
            echo "ğŸ“ ä¿å­˜ä¸º: $SAVE_AS"
            echo "ğŸŒ æºåœ°å€: $FILE_URL"
            echo "ğŸ”§ éœ€è¦å¤„ç†: $NEED_PROCESS"
            
            # ä¸‹è½½æ–‡ä»¶
            for attempt in {1..3}; do
              echo "â¬‡ï¸ ä¸‹è½½å°è¯• $attempt/3..."
              if curl -f -s -o "/tmp/${FILE_NAME}_raw.js" "$FILE_URL"; then
                FILE_SIZE=$(stat -c%s "/tmp/${FILE_NAME}_raw.js" 2>/dev/null || stat -f%z "/tmp/${FILE_NAME}_raw.js" 2>/dev/null)
                
                if [[ $FILE_SIZE -gt 100 ]]; then
                  FILE_HASH=$(sha256sum "/tmp/${FILE_NAME}_raw.js" | cut -d' ' -f1)
                  echo "âœ… ä¸‹è½½æˆåŠŸ | å¤§å°: $FILE_SIZE å­—èŠ‚ | å“ˆå¸Œ: ${FILE_HASH:0:16}..."
                  
                  # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
                  if [[ -f "$SAVE_AS" ]]; then
                    LOCAL_HASH=$(sha256sum "$SAVE_AS" 2>/dev/null | cut -d' ' -f1 || echo "missing")
                    if [[ "$LOCAL_HASH" != "$FILE_HASH" ]]; then
                      echo "ğŸ”„ æ–‡ä»¶æœ‰æ›´æ–°ï¼Œéœ€è¦ä¸‹è½½"
                      NEED_UPDATE="true"
                    else
                      echo "âœ… æ–‡ä»¶æ— å˜åŒ–ï¼Œè·³è¿‡"
                      NEED_UPDATE="false"
                    fi
                  else
                    echo "ğŸ”„ æ–‡ä»¶ä¸å­˜åœ¨ï¼Œéœ€è¦ä¸‹è½½"
                    NEED_UPDATE="true"
                  fi
                  
                  # ä¿å­˜æ–‡ä»¶ä¿¡æ¯
                  DOWNLOAD_STATUS=$(echo "$DOWNLOAD_STATUS" | jq --arg name "$FILE_NAME" --arg hash "$FILE_HASH" --arg update "$NEED_UPDATE" --arg process "$NEED_PROCESS" --arg save_as "$SAVE_AS" '.[$name] = {"hash": $hash, "need_update": $update, "need_process": $process, "save_as": $save_as}')
                  
                  if [[ "$NEED_UPDATE" == "true" ]]; then
                    UPDATE_NEEDED="true"
                  fi
                  break
                else
                  echo "âš ï¸ æ–‡ä»¶å¤§å°å¼‚å¸¸: $FILE_SIZE å­—èŠ‚"
                fi
              fi
              
              if [[ $attempt -eq 3 ]]; then
                echo "âŒ ä¸‹è½½å¤±è´¥: $FILE_NAME"
                DOWNLOAD_STATUS=$(echo "$DOWNLOAD_STATUS" | jq --arg name "$FILE_NAME" --arg status "failed" '.[$name] = {"status": $status}')
                break
              fi
              
              echo "â³ ç­‰å¾… 3 ç§’åé‡è¯•..."
              sleep 3
            done
          done
          
          echo "ğŸ“Š ä¸‹è½½å®ŒæˆæŠ¥å‘Š:"
          echo "$DOWNLOAD_STATUS" | jq '.'
          
          echo "DOWNLOAD_STATUS='$DOWNLOAD_STATUS'" >> $GITHUB_ENV
          echo "UPDATE_NEEDED='$UPDATE_NEEDED'" >> $GITHUB_ENV

      # ç¬¬ä¸‰é˜¶æ®µï¼šæ–‡ä»¶å¤„ç†
      - name: ğŸ”„ å¤„ç†éœ€è¦ä¼˜åŒ–çš„æ–‡ä»¶
        if: env.UPDATE_NEEDED == 'true'
        run: |
          echo "ğŸ› ï¸ å¼€å§‹å¤„ç†éœ€è¦ä¼˜åŒ–çš„æ–‡ä»¶..."
          
          # è¯»å–ä¸‹è½½çŠ¶æ€
          FILES_COUNT=$(jq length files_config.json)
          
          for i in $(seq 0 $(($FILES_COUNT - 1))); do
            FILE_NAME=$(jq -r ".[$i].name" files_config.json)
            SAVE_AS=$(jq -r ".[$i].save_as" files_config.json)
            NEED_PROCESS=$(jq -r ".[$i].process" files_config.json)
            NEED_UPDATE=$(echo "$DOWNLOAD_STATUS" | jq -r ".\"$FILE_NAME\".need_update")
            
            if [[ "$NEED_UPDATE" == "true" && "$NEED_PROCESS" == "true" ]]; then
              echo "---"
              echo "ğŸ”§ å¤„ç†æ–‡ä»¶: $FILE_NAME â†’ $SAVE_AS"
              
              # ç¬¬ä¸€æ­¥ï¼šä»£ç å‹ç¼©
              echo "ğŸ“¦ ä½¿ç”¨ terser è¿›è¡Œä»£ç å‹ç¼©..."
              terser "/tmp/${FILE_NAME}_raw.js" \
                --compress \
                --mangle \
                --output "/tmp/${FILE_NAME}_min.js"
              
              # ç¬¬äºŒæ­¥ï¼šä»£ç æ··æ·†
              echo "ğŸ­ ä½¿ç”¨ javascript-obfuscator è¿›è¡Œä»£ç æ··æ·†..."
              javascript-obfuscator "/tmp/${FILE_NAME}_min.js" \
                --output "$SAVE_AS" \
                --compact true \
                --control-flow-flattening true \
                --control-flow-flattening-threshold 0.75 \
                --dead-code-injection true \
                --dead-code-injection-threshold 0.4 \
                --disable-console-output true \
                --identifier-names-generator hexadecimal \
                --string-array true \
                --string-array-encoding rc4 \
                --string-array-threshold 0.8 \
                --string-array-rotate true \
                --string-array-shuffle true \
                --transform-object-keys true
              
              # ç¬¬ä¸‰æ­¥ï¼šç»“æœéªŒè¯
              if [[ -f "$SAVE_AS" ]]; then
                FINAL_SIZE=$(stat -c%s "$SAVE_AS" 2>/dev/null || stat -f%z "$SAVE_AS" 2>/dev/null)
                ORIGINAL_SIZE=$(stat -c%s "/tmp/${FILE_NAME}_raw.js" 2>/dev/null || stat -f%z "/tmp/${FILE_NAME}_raw.js" 2>/dev/null)
                RATIO=$(( (FINAL_SIZE * 100) / ORIGINAL_SIZE ))
                
                echo "ğŸ“ˆ ä¼˜åŒ–å®Œæˆ:"
                echo "   â”œâ”€ åŸå§‹å¤§å°: $ORIGINAL_SIZE å­—èŠ‚"
                echo "   â”œâ”€ å¤„ç†åå¤§å°: $FINAL_SIZE å­—èŠ‚" 
                echo "   â”œâ”€ ä½“ç§¯æ¯”ä¾‹: $RATIO%"
                echo "   â””â”€ èŠ‚çœç©ºé—´: $((ORIGINAL_SIZE - FINAL_SIZE)) å­—èŠ‚"
              else
                echo "âŒ å¤„ç†å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹æ–‡ä»¶"
                cp "/tmp/${FILE_NAME}_raw.js" "$SAVE_AS"
              fi
              
            elif [[ "$NEED_UPDATE" == "true" && "$NEED_PROCESS" == "false" ]]; then
              echo "---"
              echo "ğŸ“‹ ç›´æ¥ä¿å­˜æ–‡ä»¶: $FILE_NAME â†’ $SAVE_AS"
              cp "/tmp/${FILE_NAME}_raw.js" "$SAVE_AS"
              FILE_SIZE=$(stat -c%s "$SAVE_AS" 2>/dev/null || stat -f%z "$SAVE_AS" 2>/dev/null)
              echo "âœ… ä¿å­˜å®Œæˆ | å¤§å°: $FILE_SIZE å­—èŠ‚"
            fi
          done

      # ç¬¬å››é˜¶æ®µï¼šç‰ˆæœ¬ç®¡ç†å’Œæäº¤
      - name: ğŸ“ ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯å’Œæäº¤
        if: env.UPDATE_NEEDED == 'true'
        run: |
          echo "ğŸ“ ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯..."
          
          # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
          VERSION_INFO="{"
          VERSION_INFO+="\"updated_at\": \"$(date -Iseconds)\","
          VERSION_INFO+="\"files\": {"
          
          FIRST_FILE=true
          FILES_COUNT=$(jq length files_config.json)
          
          for i in $(seq 0 $(($FILES_COUNT - 1))); do
            FILE_NAME=$(jq -r ".[$i].name" files_config.json)
            SAVE_AS=$(jq -r ".[$i].save_as" files_config.json)
            FILE_HASH=$(echo "$DOWNLOAD_STATUS" | jq -r ".\"$FILE_NAME\".hash")
            NEED_UPDATE=$(echo "$DOWNLOAD_STATUS" | jq -r ".\"$FILE_NAME\".need_update")
            
            if [[ "$NEED_UPDATE" == "true" ]]; then
              if [[ "$FIRST_FILE" == "true" ]]; then
                FIRST_FILE=false
              else
                VERSION_INFO+=","
              fi
              
              VERSION_INFO+="\"$FILE_NAME\": \"${FILE_HASH:0:16}\""
            fi
          done
          
          VERSION_INFO+="}}"
          
          echo "$VERSION_INFO" | jq '.' > version.json
          echo "ğŸ“„ ç‰ˆæœ¬ä¿¡æ¯:"
          cat version.json

      - name: ğŸ“¤ æäº¤ä»£ç æ›´æ–°
        if: env.UPDATE_NEEDED == 'true'
        run: |
          echo "ğŸ“¤ å‡†å¤‡æäº¤ä»£ç æ›´æ–°..."
          
          # æ·»åŠ æ‰€æœ‰æ›´æ–°çš„æ–‡ä»¶åˆ°æš‚å­˜åŒº
          git add .
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…æ›´æ”¹
          if git diff --staged --quiet; then
            echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°å®é™…æ›´æ”¹ï¼Œè·³è¿‡æäº¤"
            exit 0
          fi
          
          # ç”Ÿæˆæäº¤ä¿¡æ¯
          COMMIT_MSG="ğŸ”„ Auto Update Multiple Files\n\n"
          COMMIT_MSG+="â€¢ æ›´æ–°æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')\n"
          COMMIT_MSG+="â€¢ æ›´æ–°æ–‡ä»¶:\n"
          
          FILES_COUNT=$(jq length files_config.json)
          for i in $(seq 0 $(($FILES_COUNT - 1))); do
            FILE_NAME=$(jq -r ".[$i].name" files_config.json)
            SAVE_AS=$(jq -r ".[$i].save_as" files_config.json)
            NEED_UPDATE=$(echo "$DOWNLOAD_STATUS" | jq -r ".\"$FILE_NAME\".need_update")
            
            if [[ "$NEED_UPDATE" == "true" ]]; then
              COMMIT_MSG+="  - $SAVE_AS\n"
            fi
          done
          
          COMMIT_MSG+="â€¢ è¯¦ç»†ä¿¡æ¯è¯·æŸ¥çœ‹ version.json"
          
          # æäº¤æ›´æ”¹
          echo -e "$COMMIT_MSG" | git commit -F -
          git push
          echo "âœ… ä»£ç æ›´æ–°æäº¤å®Œæˆ"

      # ç¬¬äº”é˜¶æ®µï¼šç»“æœé€šçŸ¥
      - name: ğŸ‰ æ›´æ–°æˆåŠŸé€šçŸ¥
        if: env.UPDATE_NEEDED == 'true'
        run: |
          echo "ğŸ‰ å¤šæ–‡ä»¶è‡ªåŠ¨æ›´æ–°ä»»åŠ¡å®Œæˆï¼"
          echo "::notice title=ğŸ”„ æ›´æ–°å®Œæˆ::å·²æˆåŠŸæ›´æ–°å¤šä¸ªæ–‡ä»¶ï¼Œè¯¦ç»†ä¿¡æ¯è¯·æŸ¥çœ‹æäº¤è®°å½•"

      - name: ğŸ’¤ æ— éœ€æ›´æ–°é€šçŸ¥
        if: env.UPDATE_NEEDED == 'false'
        run: |
          echo "ğŸ’¤ æ‰€æœ‰æ–‡ä»¶å‡ä¸ºæœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ–°"
          echo "::notice title=ğŸ’¤ æ— éœ€æ›´æ–°::æ‰€æœ‰æ–‡ä»¶å·²æ˜¯æœ€æ–°ç‰ˆæœ¬"

  # æ¸…ç†é˜¶æ®µ
  cleanup:
    name: ğŸ§¹ æ¸…ç†å·¥ä½œæµè®°å½•
    runs-on: ubuntu-latest
    needs: update
    permissions:
      actions: write
      contents: read
    if: always()
    steps:
      - name: ğŸ—‘ï¸ åˆ é™¤æ—§å·¥ä½œæµè¿è¡Œè®°å½•
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 3
          keep_minimum_runs_per_workflow: 2

      - name: ğŸ“‹ æ¸…ç†å®ŒæˆæŠ¥å‘Š
        run: |
          echo "ğŸ§¹ å·¥ä½œæµæ¸…ç†ä»»åŠ¡å®Œæˆ"
          echo "::notice title=ğŸ§¹ æ¸…ç†å®Œæˆ::å·²æ¸…ç†æ—§è¿è¡Œè®°å½•ï¼Œä¿ç•™æœ€è¿‘3æ¬¡è¿è¡Œ"
