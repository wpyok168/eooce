name: ğŸ”„ Auto Update Worker

on:
  push:
    branches: [ main ]
  schedule:
    - cron: "0 1 * * *"  # ğŸ• æ¯å¤©å‡Œæ™¨1ç‚¹è‡ªåŠ¨è¿è¡Œ
  workflow_dispatch:      # ğŸ–ï¸ æ”¯æŒæ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  update:
    name: ğŸš€ åŒæ­¥å’Œä¼˜åŒ– Worker æ–‡ä»¶
    runs-on: ubuntu-latest
    steps:
      # ç¬¬ä¸€é˜¶æ®µï¼šåˆå§‹åŒ–é…ç½®
      - name: ğŸ“¥ åˆå§‹åŒ–ä»£ç ä»“åº“
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ğŸ› ï¸ é…ç½® Git ç¯å¢ƒ
        run: |
          echo "ğŸ¯ é…ç½® Git ç”¨æˆ·ä¿¡æ¯..."
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global pull.rebase false

      - name: ğŸ“¦ å®‰è£…æ„å»ºå·¥å…·
        run: |
          echo "ğŸ”§ å®‰è£…ä»£ç å‹ç¼©å’Œæ··æ·†å·¥å…·..."
          npm install -g terser javascript-obfuscator
          echo "âœ… å·¥å…·å®‰è£…å®Œæˆ"

      # ç¬¬äºŒé˜¶æ®µï¼šæ–‡ä»¶çŠ¶æ€æ£€æŸ¥
      - name: ğŸ” æ£€æŸ¥æ–‡ä»¶çŠ¶æ€
        id: file_check
        run: |
          echo "ğŸ“‹ å¼€å§‹æ–‡ä»¶çŠ¶æ€æ£€æŸ¥..."
          
          # æ£€æŸ¥ç‰ˆæœ¬æ–‡ä»¶
          if [[ -f "version.txt" ]]; then
            LOCAL_VERSION=$(cat version.txt)
            echo "ğŸ“„ version.txt å­˜åœ¨ | ç‰ˆæœ¬: $LOCAL_VERSION"
            echo "HAS_VERSION=true" >> $GITHUB_ENV
          else
            echo "ğŸ“ version.txt ä¸å­˜åœ¨ | é¦–æ¬¡è¿è¡Œ"
            echo "HAS_VERSION=false" >> $GITHUB_ENV
          fi
          
          # æ£€æŸ¥å¿…è¦æ–‡ä»¶
          if [[ "$HAS_VERSION" == "false" || ! -f "source.js" || ! -f "_worker.js" ]]; then
            echo "ğŸ”„ æ£€æµ‹åˆ°æ–‡ä»¶ç¼ºå¤± | è§¦å‘å¼ºåˆ¶æ›´æ–°"
            echo "FORCE_UPDATE=true" >> $GITHUB_ENV
          else
            echo "âœ… æ‰€æœ‰æ–‡ä»¶æ­£å¸¸ | ç»§ç»­ç‰ˆæœ¬æ£€æŸ¥"
            echo "FORCE_UPDATE=false" >> $GITHUB_ENV
          fi

      # ç¬¬ä¸‰é˜¶æ®µï¼šè¿œç¨‹æ–‡ä»¶è·å–
      - name: ğŸŒ è·å–è¿œç¨‹æ–‡ä»¶
        id: fetch_remote
        run: |
          echo "ğŸŒ å¼€å§‹è·å–è¿œç¨‹æ–‡ä»¶..."
          REMOTE_URL="https://raw.githubusercontent.com/eooce/Cloudflare-proxy/refs/heads/main/_worker.js"
          
          for attempt in {1..3}; do
            echo "ğŸ”„ å°è¯•ç¬¬ $attempt/3 æ¬¡è·å–..."
            
            if curl -f -s -o /tmp/remote_worker.js "$REMOTE_URL"; then
              FILE_SIZE=$(stat -c%s /tmp/remote_worker.js 2>/dev/null || stat -f%z /tmp/remote_worker.js 2>/dev/null)
              
              if [[ $FILE_SIZE -gt 1000 ]]; then
                FILE_HASH=$(sha256sum /tmp/remote_worker.js | cut -d' ' -f1)
                echo "âœ… è¿œç¨‹æ–‡ä»¶è·å–æˆåŠŸ"
                echo "ğŸ“Š æ–‡ä»¶å¤§å°: $FILE_SIZE å­—èŠ‚"
                echo "ğŸ” æ–‡ä»¶å“ˆå¸Œ: ${FILE_HASH:0:16}..."
                echo "REMOTE_VERSION=$FILE_HASH" >> $GITHUB_ENV
                break
              else
                echo "âš ï¸ æ–‡ä»¶å¤§å°å¼‚å¸¸: $FILE_SIZE å­—èŠ‚"
              fi
            fi
            
            if [[ $attempt -eq 3 ]]; then
              echo "âŒ è·å–è¿œç¨‹æ–‡ä»¶å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥"
              exit 1
            fi
            
            echo "â³ ç­‰å¾… 5 ç§’åé‡è¯•..."
            sleep 5
          done

      # ç¬¬å››é˜¶æ®µï¼šæ›´æ–°å†³ç­–
      - name: ğŸ“Š ç‰ˆæœ¬æ¯”å¯¹åˆ†æ
        id: version_analysis
        run: |
          echo "ğŸ“Š å¼€å§‹ç‰ˆæœ¬æ¯”å¯¹åˆ†æ..."
          
          if [[ "$FORCE_UPDATE" == "true" ]]; then
            echo "ğŸ”„ å†³ç­–: æ–‡ä»¶ç¼ºå¤± â†’ å¼ºåˆ¶æ›´æ–°"
            echo "UPDATE_NEEDED=true" >> $GITHUB_ENV
          elif [[ -f "version.txt" ]]; then
            LOCAL_VERSION=$(cat version.txt)
            if [[ "$LOCAL_VERSION" == "$REMOTE_VERSION" ]]; then
              echo "âœ… å†³ç­–: ç‰ˆæœ¬ä¸€è‡´ â†’ æ— éœ€æ›´æ–°"
              echo "UPDATE_NEEDED=false" >> $GITHUB_ENV
            else
              echo "ğŸ”„ å†³ç­–: ç‰ˆæœ¬ä¸åŒ â†’ éœ€è¦æ›´æ–°"
              echo "UPDATE_NEEDED=true" >> $GITHUB_ENV
            fi
          else
            echo "ğŸ”„ å†³ç­–: é¦–æ¬¡è¿è¡Œ â†’ éœ€è¦æ›´æ–°"
            echo "UPDATE_NEEDED=true" >> $GITHUB_ENV
          fi

      # ç¬¬äº”é˜¶æ®µï¼šæ–‡ä»¶å¤„ç†
      - name: ğŸ’¾ ä¿å­˜åŸå§‹æ–‡ä»¶
        if: env.UPDATE_NEEDED == 'true'
        run: |
          echo "ğŸ’¾ ä¿å­˜åŸå§‹æ–‡ä»¶..."
          cp /tmp/remote_worker.js source.js
          echo "âœ… source.js ä¿å­˜å®Œæˆ"

      - name: ğŸ”„ ä»£ç å‹ç¼©æ··æ·†
        if: env.UPDATE_NEEDED == 'true'
        run: |
          echo "ğŸ› ï¸ å¼€å§‹ä»£ç ä¼˜åŒ–å¤„ç†..."
          
          # ç¬¬ä¸€æ­¥ï¼šä»£ç å‹ç¼©
          echo "ğŸ“¦ ä½¿ç”¨ terser è¿›è¡Œä»£ç å‹ç¼©..."
          terser /tmp/remote_worker.js \
            --compress \
            --mangle \
            --output /tmp/min_worker.js
          
          # ç¬¬äºŒæ­¥ï¼šä»£ç æ··æ·†
          echo "ğŸ­ ä½¿ç”¨ javascript-obfuscator è¿›è¡Œä»£ç æ··æ·†..."
          javascript-obfuscator /tmp/min_worker.js \
            --output _worker.js \
            --compact true \
            --control-flow-flattening true \
            --control-flow-flattening-threshold 0.75 \
            --dead-code-injection true \
            --dead-code-injection-threshold 0.4 \
            --disable-console-output true \
            --identifier-names-generator hexadecimal \
            --string-array true \
            --string-array-encoding rc4 \
            --string-array-threshold 0.8 \
            --string-array-rotate true \
            --string-array-shuffle true \
            --transform-object-keys true
          
          # ç¬¬ä¸‰æ­¥ï¼šç»“æœéªŒè¯
          if [[ -f "_worker.js" ]]; then
            FINAL_SIZE=$(stat -c%s _worker.js 2>/dev/null || stat -f%z _worker.js 2>/dev/null)
            ORIGINAL_SIZE=$(stat -c%s source.js 2>/dev/null || stat -f%z source.js 2>/dev/null)
            RATIO=$(( (FINAL_SIZE * 100) / ORIGINAL_SIZE ))
            
            echo "ğŸ“ˆ ä¼˜åŒ–å®ŒæˆæŠ¥å‘Š:"
            echo "   â”œâ”€ åŸå§‹å¤§å°: $ORIGINAL_SIZE å­—èŠ‚"
            echo "   â”œâ”€ å¤„ç†åå¤§å°: $FINAL_SIZE å­—èŠ‚" 
            echo "   â”œâ”€ ä½“ç§¯æ¯”ä¾‹: $RATIO%"
            echo "   â””â”€ èŠ‚çœç©ºé—´: $((ORIGINAL_SIZE - FINAL_SIZE)) å­—èŠ‚"
            
            if [[ $FINAL_SIZE -gt 1048576 ]]; then
              echo "âš ï¸ æ³¨æ„: æ–‡ä»¶è¶…è¿‡ 1MBï¼Œå¯èƒ½å½±å“ Cloudflare éƒ¨ç½²"
            fi
          else
            echo "âŒ æ··æ·†å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹æ–‡ä»¶ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ"
            cp /tmp/remote_worker.js _worker.js
          fi

      # ç¬¬å…­é˜¶æ®µï¼šæäº¤æ›´æ”¹
      - name: ğŸ“ æäº¤ä»£ç æ›´æ–°
        if: env.UPDATE_NEEDED == 'true'
        run: |
          echo "ğŸ“ å‡†å¤‡æäº¤ä»£ç æ›´æ–°..."
          
          # æ›´æ–°ç‰ˆæœ¬æ–‡ä»¶
          echo "$REMOTE_VERSION" > version.txt
          
          # æ·»åŠ æ–‡ä»¶åˆ°æš‚å­˜åŒº
          git add source.js _worker.js version.txt
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…æ›´æ”¹
          if git diff --staged --quiet; then
            echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°å®é™…æ›´æ”¹ï¼Œè·³è¿‡æäº¤"
            exit 0
          fi
          
          # æäº¤æ›´æ”¹
          git commit -m "ğŸ”„ Auto Update Worker

          â€¢ åŒæ­¥æœ€æ–° Worker æ–‡ä»¶ï¼ˆæ··æ·†ç‰ˆï¼‰
          â€¢ ç‰ˆæœ¬: ${REMOTE_VERSION:0:16}...
          â€¢ æ›´æ–°æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
          â€¢ ä¼˜åŒ–å¤„ç†: å‹ç¼© + æ··æ·†"
          
          # æ¨é€æ›´æ”¹
          git push
          echo "âœ… ä»£ç æ›´æ–°æäº¤å®Œæˆ"

      # ç¬¬ä¸ƒé˜¶æ®µï¼šç»“æœé€šçŸ¥
      - name: ğŸ‰ æ›´æ–°æˆåŠŸé€šçŸ¥
        if: env.UPDATE_NEEDED == 'true'
        run: |
          echo "ğŸ‰ è‡ªåŠ¨æ›´æ–°ä»»åŠ¡å®Œæˆï¼"
          echo "::notice title=ğŸ”„ æ›´æ–°å®Œæˆ::å·²æˆåŠŸåŒæ­¥ã€å‹ç¼©å¹¶æ··æ·†ä»£ç ï¼Œç‰ˆæœ¬: ${REMOTE_VERSION:0:16}..."

      - name: ğŸ’¤ æ— éœ€æ›´æ–°é€šçŸ¥
        if: env.UPDATE_NEEDED == 'false'
        run: |
          echo "ğŸ’¤ å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ–°"
          echo "::notice title=ğŸ’¤ æ— éœ€æ›´æ–°::å½“å‰ Worker æ–‡ä»¶å·²æ˜¯æœ€æ–°ç‰ˆæœ¬"

  # æ¸…ç†é˜¶æ®µ
  cleanup:
    name: ğŸ§¹ æ¸…ç†å·¥ä½œæµè®°å½•
    runs-on: ubuntu-latest
    needs: update
    permissions:
      actions: write
      contents: read
    if: always()
    steps:
      - name: ğŸ—‘ï¸ åˆ é™¤æ—§å·¥ä½œæµè¿è¡Œè®°å½•
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 3
          keep_minimum_runs_per_workflow: 2

      - name: ğŸ“‹ æ¸…ç†å®ŒæˆæŠ¥å‘Š
        run: |
          echo "ğŸ§¹ å·¥ä½œæµæ¸…ç†ä»»åŠ¡å®Œæˆ"
          echo "::notice title=ğŸ§¹ æ¸…ç†å®Œæˆ::å·²æ¸…ç†æ—§è¿è¡Œè®°å½•ï¼Œä¿ç•™æœ€è¿‘3æ¬¡è¿è¡Œ"
