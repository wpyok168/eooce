name: ðŸ”„ è‡ªåŠ¨æ›´æ–°å¤šä¸ªæ–‡ä»¶

on:
  push:
    branches: [ main ]
  schedule:
    - cron: "0 1 * * *"  # ðŸ• æ¯å¤©å‡Œæ™¨1ç‚¹è‡ªåŠ¨è¿è¡Œ
  workflow_dispatch:      # ðŸ–ï¸ æ”¯æŒæ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  update:
    name: ðŸš€ åŒæ­¥å¤šæºæ–‡ä»¶
    runs-on: ubuntu-latest
    steps:
      # ç¬¬ä¸€é˜¶æ®µï¼šåˆå§‹åŒ–é…ç½®
      - name: ðŸ“¥ åˆå§‹åŒ–ä»£ç ä»“åº“
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ðŸ› ï¸ é…ç½® Git çŽ¯å¢ƒ
        run: |
          echo "ðŸŽ¯ é…ç½® Git ç”¨æˆ·ä¿¡æ¯..."
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global pull.rebase false

      - name: ðŸ“¦ å®‰è£…å¿…è¦å·¥å…·
        run: |
          echo "ðŸ”§ å®‰è£…å¿…è¦å·¥å…·..."
          npm install -g terser javascript-obfuscator
          sudo apt-get install -y jq
          echo "âœ… å·¥å…·å®‰è£…å®Œæˆ"

      # ç¬¬äºŒé˜¶æ®µï¼šæ–‡ä»¶ä¸‹è½½
      - name: ðŸŒ ä¸‹è½½ Worker ä¸»æ–‡ä»¶
        id: download_worker
        run: |
          echo "ðŸ“¥ ä¸‹è½½ Worker ä¸»æ–‡ä»¶..."
          WORKER_URL="https://raw.githubusercontent.com/cmliu/edgetunnel/refs/heads/beta2.0/_worker.js"
          
          for attempt in {1..3}; do
            echo "â¬‡ï¸ ä¸‹è½½å°è¯• $attempt/3..."
            if curl -f -s -o "/tmp/worker_raw.js" "$WORKER_URL"; then
              FILE_SIZE=$(stat -c%s "/tmp/worker_raw.js" 2>/dev/null || stat -f%z "/tmp/worker_raw.js" 2>/dev/null)
              if [[ $FILE_SIZE -gt 1000 ]]; then
                WORKER_HASH=$(sha256sum "/tmp/worker_raw.js" | cut -d' ' -f1)
                echo "âœ… Worker æ–‡ä»¶ä¸‹è½½æˆåŠŸ"
                echo "WORKER_HASH=$WORKER_HASH" >> $GITHUB_ENV
                break
              fi
            fi
            if [[ $attempt -eq 3 ]]; then
              echo "âŒ Worker æ–‡ä»¶ä¸‹è½½å¤±è´¥"
              exit 1
            fi
            sleep 3
          done

      - name: ðŸŒ ä¸‹è½½ Shadowsocks æ–‡ä»¶
        id: download_shadowsocks
        run: |
          echo "ðŸ“¥ ä¸‹è½½ Shadowsocks æ–‡ä»¶..."
          SS_URL="https://raw.githubusercontent.com/eooce/Cloudflare-proxy/refs/heads/main/shadowsocks.js"
          
          for attempt in {1..3}; do
            echo "â¬‡ï¸ ä¸‹è½½å°è¯• $attempt/3..."
            if curl -f -s -o "/tmp/shadowsocks_raw.js" "$SS_URL"; then
              FILE_SIZE=$(stat -c%s "/tmp/shadowsocks_raw.js" 2>/dev/null || stat -f%z "/tmp/shadowsocks_raw.js" 2>/dev/null)
              if [[ $FILE_SIZE -gt 100 ]]; then
                SS_HASH=$(sha256sum "/tmp/shadowsocks_raw.js" | cut -d' ' -f1)
                echo "âœ… Shadowsocks æ–‡ä»¶ä¸‹è½½æˆåŠŸ"
                echo "SS_HASH=$SS_HASH" >> $GITHUB_ENV
                break
              fi
            fi
            if [[ $attempt -eq 3 ]]; then
              echo "âŒ Shadowsocks æ–‡ä»¶ä¸‹è½½å¤±è´¥"
              exit 1
            fi
            sleep 3
          done

      - name: ðŸŒ ä¸‹è½½ Snippets æ–‡ä»¶
        id: download_snippets
        run: |
          echo "ðŸ“¥ ä¸‹è½½ Snippets æ–‡ä»¶..."
          SNIPPETS_URL="https://raw.githubusercontent.com/eooce/Cloudflare-proxy/refs/heads/main/snippets.js"
          
          for attempt in {1..3}; do
            echo "â¬‡ï¸ ä¸‹è½½å°è¯• $attempt/3..."
            if curl -f -s -o "/tmp/snippets_raw.js" "$SNIPPETS_URL"; then
              FILE_SIZE=$(stat -c%s "/tmp/snippets_raw.js" 2>/dev/null || stat -f%z "/tmp/snippets_raw.js" 2>/dev/null)
              if [[ $FILE_SIZE -gt 100 ]]; then
                SNIPPETS_HASH=$(sha256sum "/tmp/snippets_raw.js" | cut -d' ' -f1)
                echo "âœ… Snippets æ–‡ä»¶ä¸‹è½½æˆåŠŸ"
                echo "SNIPPETS_HASH=$SNIPPETS_HASH" >> $GITHUB_ENV
                break
              fi
            fi
            if [[ $attempt -eq 3 ]]; then
              echo "âŒ Snippets æ–‡ä»¶ä¸‹è½½å¤±è´¥"
              exit 1
            fi
            sleep 3
          done

      # ç¬¬ä¸‰é˜¶æ®µï¼šç‰ˆæœ¬æ£€æŸ¥
      - name: ðŸ” æ£€æŸ¥æ–‡ä»¶æ›´æ–°çŠ¶æ€
        id: check_updates
        run: |
          echo "ðŸ” æ£€æŸ¥æ–‡ä»¶æ›´æ–°çŠ¶æ€..."
          UPDATE_NEEDED="false"
          
          # æ£€æŸ¥ Worker æ–‡ä»¶
          if [[ -f "source.js" ]]; then
            LOCAL_WORKER_HASH=$(sha256sum "source.js" 2>/dev/null | cut -d' ' -f1 || echo "missing")
            if [[ "$LOCAL_WORKER_HASH" != "$WORKER_HASH" ]]; then
              echo "ðŸ”„ Worker æ–‡ä»¶æœ‰æ›´æ–°"
              echo "WORKER_UPDATE=true" >> $GITHUB_ENV
              UPDATE_NEEDED="true"
            else
              echo "âœ… Worker æ–‡ä»¶æ— å˜åŒ–"
              echo "WORKER_UPDATE=false" >> $GITHUB_ENV
            fi
          else
            echo "ðŸ”„ Worker æ–‡ä»¶ä¸å­˜åœ¨ï¼Œéœ€è¦ä¸‹è½½"
            echo "WORKER_UPDATE=true" >> $GITHUB_ENV
            UPDATE_NEEDED="true"
          fi
          
          # æ£€æŸ¥ Shadowsocks æ–‡ä»¶
          if [[ -f "shadowsocks.js" ]]; then
            LOCAL_SS_HASH=$(sha256sum "shadowsocks.js" 2>/dev/null | cut -d' ' -f1 || echo "missing")
            if [[ "$LOCAL_SS_HASH" != "$SS_HASH" ]]; then
              echo "ðŸ”„ Shadowsocks æ–‡ä»¶æœ‰æ›´æ–°"
              echo "SS_UPDATE=true" >> $GITHUB_ENV
              UPDATE_NEEDED="true"
            else
              echo "âœ… Shadowsocks æ–‡ä»¶æ— å˜åŒ–"
              echo "SS_UPDATE=false" >> $GITHUB_ENV
            fi
          else
            echo "ðŸ”„ Shadowsocks æ–‡ä»¶ä¸å­˜åœ¨ï¼Œéœ€è¦ä¸‹è½½"
            echo "SS_UPDATE=true" >> $GITHUB_ENV
            UPDATE_NEEDED="true"
          fi
          
          # æ£€æŸ¥ Snippets æ–‡ä»¶
          if [[ -f "snippets.js" ]]; then
            LOCAL_SNIPPETS_HASH=$(sha256sum "snippets.js" 2>/dev/null | cut -d' ' -f1 || echo "missing")
            if [[ "$LOCAL_SNIPPETS_HASH" != "$SNIPPETS_HASH" ]]; then
              echo "ðŸ”„ Snippets æ–‡ä»¶æœ‰æ›´æ–°"
              echo "SNIPPETS_UPDATE=true" >> $GITHUB_ENV
              UPDATE_NEEDED="true"
            else
              echo "âœ… Snippets æ–‡ä»¶æ— å˜åŒ–"
              echo "SNIPPETS_UPDATE=false" >> $GITHUB_ENV
            fi
          else
            echo "ðŸ”„ Snippets æ–‡ä»¶ä¸å­˜åœ¨ï¼Œéœ€è¦ä¸‹è½½"
            echo "SNIPPETS_UPDATE=true" >> $GITHUB_ENV
            UPDATE_NEEDED="true"
          fi
          
          echo "UPDATE_NEEDED=$UPDATE_NEEDED" >> $GITHUB_ENV
          echo "ðŸ“Š æ›´æ–°çŠ¶æ€: $UPDATE_NEEDED"

      # ç¬¬å››é˜¶æ®µï¼šæ–‡ä»¶å¤„ç†
      - name: ðŸ’¾ ä¿å­˜ Worker æ–‡ä»¶
        if: env.WORKER_UPDATE == 'true'
        run: |
          echo "ðŸ’¾ ä¿å­˜ Worker åŽŸå§‹æ–‡ä»¶..."
          cp /tmp/worker_raw.js source.js
          echo "âœ… source.js ä¿å­˜å®Œæˆ"

      - name: ðŸ”„ å¤„ç† Worker ä»£ç 
        if: env.WORKER_UPDATE == 'true'
        run: |
          echo "ðŸ› ï¸ å¤„ç† Worker ä»£ç ..."
          
          # ç¬¬ä¸€æ­¥ï¼šä»£ç åŽ‹ç¼©
          echo "ðŸ“¦ ä½¿ç”¨ terser è¿›è¡Œä»£ç åŽ‹ç¼©..."
          terser /tmp/worker_raw.js \
            --compress \
            --mangle \
            --output /tmp/worker_min.js
          
          # ç¬¬äºŒæ­¥ï¼šä»£ç æ··æ·†
          echo "ðŸŽ­ ä½¿ç”¨ javascript-obfuscator è¿›è¡Œä»£ç æ··æ·†..."
          javascript-obfuscator /tmp/worker_min.js \
            --output _worker.js \
            --compact true \
            --control-flow-flattening true \
            --control-flow-flattening-threshold 0.75 \
            --dead-code-injection true \
            --dead-code-injection-threshold 0.4 \
            --disable-console-output true \
            --identifier-names-generator hexadecimal \
            --string-array true \
            --string-array-encoding rc4 \
            --string-array-threshold 0.8 \
            --string-array-rotate true \
            --string-array-shuffle true \
            --transform-object-keys true
          
          # ç¬¬ä¸‰æ­¥ï¼šç»“æžœéªŒè¯
          if [[ -f "_worker.js" ]]; then
            FINAL_SIZE=$(stat -c%s "_worker.js" 2>/dev/null || stat -f%z "_worker.js" 2>/dev/null)
            ORIGINAL_SIZE=$(stat -c%s "source.js" 2>/dev/null || stat -f%z "source.js" 2>/dev/null)
            RATIO=$(( (FINAL_SIZE * 100) / ORIGINAL_SIZE ))
            
            echo "ðŸ“ˆ Worker ä¼˜åŒ–å®Œæˆ:"
            echo "   â”œâ”€ åŽŸå§‹å¤§å°: $ORIGINAL_SIZE å­—èŠ‚"
            echo "   â”œâ”€ å¤„ç†åŽå¤§å°: $FINAL_SIZE å­—èŠ‚" 
            echo "   â”œâ”€ ä½“ç§¯æ¯”ä¾‹: $RATIO%"
            echo "   â””â”€ èŠ‚çœç©ºé—´: $((ORIGINAL_SIZE - FINAL_SIZE)) å­—èŠ‚"
          else
            echo "âŒ Worker å¤„ç†å¤±è´¥ï¼Œä½¿ç”¨åŽŸå§‹æ–‡ä»¶"
            cp /tmp/worker_raw.js _worker.js
          fi

      - name: ðŸ’¾ ä¿å­˜ Shadowsocks æ–‡ä»¶
        if: env.SS_UPDATE == 'true'
        run: |
          echo "ðŸ’¾ ä¿å­˜ Shadowsocks æ–‡ä»¶..."
          cp /tmp/shadowsocks_raw.js shadowsocks.js
          FILE_SIZE=$(stat -c%s "shadowsocks.js" 2>/dev/null || stat -f%z "shadowsocks.js" 2>/dev/null)
          echo "âœ… shadowsocks.js ä¿å­˜å®Œæˆ | å¤§å°: $FILE_SIZE å­—èŠ‚"

      - name: ðŸ’¾ ä¿å­˜ Snippets æ–‡ä»¶
        if: env.SNIPPETS_UPDATE == 'true'
        run: |
          echo "ðŸ’¾ ä¿å­˜ Snippets æ–‡ä»¶..."
          cp /tmp/snippets_raw.js snippets.js
          FILE_SIZE=$(stat -c%s "snippets.js" 2>/dev/null || stat -f%z "snippets.js" 2>/dev/null)
          echo "âœ… snippets.js ä¿å­˜å®Œæˆ | å¤§å°: $FILE_SIZE å­—èŠ‚"

      # ç¬¬äº”é˜¶æ®µï¼šç‰ˆæœ¬ç®¡ç†å’Œæäº¤
      - name: ðŸ“ ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯
        if: env.UPDATE_NEEDED == 'true'
        run: |
          echo "ðŸ“ ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯..."
          cat > version.json << EOF
          {
            "updated_at": "$(date -Iseconds)",
            "files": {
              "worker_source": "${WORKER_HASH:0:16}",
              "shadowsocks": "${SS_HASH:0:16}", 
              "snippets": "${SNIPPETS_HASH:0:16}"
            }
          }
          EOF
          echo "ðŸ“„ ç‰ˆæœ¬ä¿¡æ¯å·²ç”Ÿæˆ:"
          cat version.json

      - name: ðŸ“¤ æäº¤ä»£ç æ›´æ–°
        if: env.UPDATE_NEEDED == 'true'
        run: |
          echo "ðŸ“¤ å‡†å¤‡æäº¤ä»£ç æ›´æ–°..."
          
          # æ·»åŠ æ‰€æœ‰æ–‡ä»¶åˆ°æš‚å­˜åŒº
          git add .
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å®žé™…æ›´æ”¹
          if git diff --staged --quiet; then
            echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°å®žé™…æ›´æ”¹ï¼Œè·³è¿‡æäº¤"
            exit 0
          fi
          
          # ç”Ÿæˆæäº¤ä¿¡æ¯
          COMMIT_MSG="ðŸ”„ è‡ªåŠ¨æ›´æ–°å¤šä¸ªæ–‡ä»¶"
          COMMIT_MSG+=$'\n'
          COMMIT_MSG+=$'\n'
          COMMIT_MSG+="â€¢ æ›´æ–°æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          COMMIT_MSG+=$'\n'
          COMMIT_MSG+="â€¢ æ›´æ–°æ–‡ä»¶:"
          COMMIT_MSG+=$'\n'
          
          if [[ "$WORKER_UPDATE" == "true" ]]; then
            COMMIT_MSG+="  - source.js (Worker æºæ–‡ä»¶)"
            COMMIT_MSG+=$'\n'
            COMMIT_MSG+="  - _worker.js (æ··æ·†ç‰ˆ)"
            COMMIT_MSG+=$'\n'
          fi
          if [[ "$SS_UPDATE" == "true" ]]; then
            COMMIT_MSG+="  - shadowsocks.js"
            COMMIT_MSG+=$'\n'
          fi
          if [[ "$SNIPPETS_UPDATE" == "true" ]]; then
            COMMIT_MSG+="  - snippets.js"
            COMMIT_MSG+=$'\n'
          fi
          
          COMMIT_MSG+=$'\n'
          COMMIT_MSG+="â€¢ ç‰ˆæœ¬å“ˆå¸Œ:"
          COMMIT_MSG+=$'\n'
          COMMIT_MSG+="  - Worker: ${WORKER_HASH:0:16}"
          COMMIT_MSG+=$'\n'
          COMMIT_MSG+="  - Shadowsocks: ${SS_HASH:0:16}"
          COMMIT_MSG+=$'\n'
          COMMIT_MSG+="  - Snippets: ${SNIPPETS_HASH:0:16}"
          
          # æäº¤æ›´æ”¹
          git commit -m "$COMMIT_MSG"
          git push
          echo "âœ… ä»£ç æ›´æ–°æäº¤å®Œæˆ"

      # ç¬¬å…­é˜¶æ®µï¼šç»“æžœé€šçŸ¥
      - name: ðŸŽ‰ æ›´æ–°æˆåŠŸé€šçŸ¥
        if: env.UPDATE_NEEDED == 'true'
        run: |
          echo "ðŸŽ‰ å¤šæ–‡ä»¶è‡ªåŠ¨æ›´æ–°ä»»åŠ¡å®Œæˆï¼"
          echo "::notice title=ðŸ”„ æ›´æ–°å®Œæˆ::å·²æˆåŠŸæ›´æ–°å¤šä¸ªæ–‡ä»¶ï¼Œè¯¦ç»†ä¿¡æ¯è¯·æŸ¥çœ‹æäº¤è®°å½•"

      - name: ðŸ’¤ æ— éœ€æ›´æ–°é€šçŸ¥
        if: env.UPDATE_NEEDED == 'false'
        run: |
          echo "ðŸ’¤ æ‰€æœ‰æ–‡ä»¶å‡ä¸ºæœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ–°"
          echo "::notice title=ðŸ’¤ æ— éœ€æ›´æ–°::æ‰€æœ‰æ–‡ä»¶å·²æ˜¯æœ€æ–°ç‰ˆæœ¬"

  # æ¸…ç†é˜¶æ®µ
  cleanup:
    name: ðŸ§¹ æ¸…ç†å·¥ä½œæµè®°å½•
    runs-on: ubuntu-latest
    needs: update
    permissions:
      actions: write
      contents: read
    if: always()
    steps:
      - name: ðŸ—‘ï¸ åˆ é™¤æ—§å·¥ä½œæµè¿è¡Œè®°å½•
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 3
          keep_minimum_runs_per_workflow: 2

      - name: ðŸ“‹ æ¸…ç†å®ŒæˆæŠ¥å‘Š
        run: |
          echo "ðŸ§¹ å·¥ä½œæµæ¸…ç†ä»»åŠ¡å®Œæˆ"
          echo "::notice title=ðŸ§¹ æ¸…ç†å®Œæˆ::å·²æ¸…ç†æ—§è¿è¡Œè®°å½•ï¼Œä¿ç•™æœ€è¿‘3æ¬¡è¿è¡Œ"
